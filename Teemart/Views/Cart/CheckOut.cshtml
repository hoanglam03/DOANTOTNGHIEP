@model List<Nhom9.Models.SanPhamChiTiet>
@{
    ViewBag.Title = "Đặt hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var info = System.Globalization.CultureInfo.GetCultureInfo("vi-VN");
    Decimal tongtien = 0;
}

<!-- Breadcrumb Start -->
<div class="breadcrumb-area mt-30">
    <div class="container">
        <div class="breadcrumb">
            <ul class="d-flex align-items-center">
                <li>@Html.ActionLink("Trang chủ", "Index", "Home")</li>
                <li class="active">@Html.ActionLink("Đặt hàng", "CheckOut", "Cart")</li>
            </ul>
        </div>
    </div>
    <!-- Container End -->
</div>
<!-- Breadcrumb End -->
<div class="checkout-area pb-100 pt-15 pb-sm-60">
    <div class="container">
        <div class="row">
            <form class="col-lg-6 col-md-6" id="add-bill-form" action="@Url.Action("CreateOrder", "Cart")" method="post">
                <div class="checkbox-form mb-sm-40">
                    <h3>Thông tin nhận hàng</h3>
                    <input type="hidden" name="matk" value="@ViewBag.TaiKhoan.MaTK" />
                    <div class="row">
                        <div class="col-md-12">
                            <div class="checkout-form-list mb-30">
                                <label>Họ tên</label>
                                <input type="text" required placeholder="Họ tên người nhận" name="hotennguoinhan" value="@ViewBag.TaiKhoan.HoTen" />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="checkout-form-list mb-30">
                                <label>Số điện thoại</label>
                                <input type="text" required placeholder="Số điện thoại người nhận" name="sodienthoainhan" value="@ViewBag.TaiKhoan.SoDienThoai" />
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="checkout-form-list mb-30">
                                <label>Địa chỉ</label>
                                <input type="text" name="diachinhan" required placeholder="Địa chỉ người nhận" value="@ViewBag.TaiKhoan.DiaChi" />
                            </div>
                        </div>

                    </div>
                    <div class="different-address">
                        <div class="order-notes">
                            <div class="checkout-form-list">
                                <label>Ghi chú</label>
                                <textarea id="checkout-mess" cols="30" name="ghichu" rows="10" placeholder="Ghi chú cho đơn hàng của bạn"></textarea>
                            </div>
                        </div>
                        <!-- Phương thức thanh toán -->
                        <div class="payment-method mt-30">
                            <h3>Phương thức thanh toán</h3>
                            <div class="payment-method-options">
                                <div class="payment-option">
                                    <input type="radio" id="payment-cod" name="paymentMethod" value="COD" checked>
                                    <label for="payment-cod">Thanh toán khi nhận hàng (COD)</label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="payment-vnpay" name="paymentMethod" value="VNPAY">
                                    <label for="payment-vnpay">Thanh toán qua VNPAY</label>
                                    <div class="vnpay-logo ml-3">
                                        <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-VNPAY-QR-1.png" alt="VNPAY" style="height: 40px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="tongtien" id="tongtien" value="@tongtien" />
            </form>
            <div class="col-lg-6 col-md-6">
                <div class="your-order">
                    <h3>Đơn hàng của bạn</h3>
                    <div class="your-order-table table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="product-name">Sản phẩm</th>

                                    <th class="product-total">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr class="cart_item">
                                        <td class="product-name">
                                            @item.SanPham.TenSP <span class="product-quantity">x @item.ChiTietHoaDons.First().SoLuongMua</span>
                                        </td>
                                        <td class="product-total">
                                            <span class="amount">@(string.Format(info,"{0:c0}", item.ChiTietHoaDons.First().GiaMua * item.ChiTietHoaDons.First().SoLuongMua))</span>
                                        </td>
                                    </tr>
                                    tongtien += item.ChiTietHoaDons.First().GiaMua * item.ChiTietHoaDons.First().SoLuongMua;
                                }
                            </tbody>
                            <tfoot>
                                <tr class="order-total">
                                    <th>Tổng đơn hàng</th>
                                    <td>
                                        <span class="total amount">@(string.Format(info, "{0:c0}",tongtien))</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <p id="add-message"></p>
        <div class="float-md-right">
            <button type="button" onclick="datHang()" class="return-customer-btn">Đặt hàng</button>
        </div>
    </div>
</div>

<script>
    function datHang() {
        var paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        var form = document.getElementById('add-bill-form');

        if (paymentMethod === "VNPAY") {
            var matk = form.elements['matk'].value;
            var hotennguoinhan = form.elements['hotennguoinhan'].value;
            var sodienthoainhan = form.elements['sodienthoainhan'].value;
            var diachinhan = form.elements['diachinhan'].value;
            var ghichu = form.elements['ghichu'].value;

           var tongtien = Number('@tongtien.ToString(System.Globalization.CultureInfo.InvariantCulture)');


            $.ajax({
                url: '@Url.Action("CreatePaymentVNPay", "Cart")',
                type: 'POST',
                data: {
                    matk: matk,
                    hotennguoinhan: hotennguoinhan,
                    sodienthoainhan: sodienthoainhan,
                    diachinhan: diachinhan,
                    ghichu: ghichu,
                    tongtien: tongtien
                },
                success: function (data) {
                    if (data.success) {
                        window.location.href = data.paymentUrl;
                    } else {
                        document.getElementById('add-message').innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
                    }
                },
                error: function () {
                    document.getElementById('add-message').innerHTML = '<div class="alert alert-danger">Có lỗi xảy ra, vui lòng thử lại sau!</div>';
                }
            });
        } else {
            form.submit();
        }
    }
</script>